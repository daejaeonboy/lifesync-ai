# 버그수정

> LifeSync AI 개발 중 발견하고 해결한 버그들

---

## 🐛 AI 중복 글 작성 문제

### 날짜
2026-02-03

### 증상
AI 페르소나가 **동일한 내용의 글을 2번 작성**하는 현상.
예: MOMO가 같은 축하 메시지를 연속으로 2번 게시.

### 원인 분석

#### 문제 코드
```typescript
const addEntry = (content: string, mood: JournalEntry['mood']) => {
  setEntries(prev => {
    triggerAI({ ... });  // ❌ setState 콜백 안에서 호출
    return [newEntry, ...prev];
  });
};
```

#### 근본 원인: React Strict Mode
React 18부터 개발 모드에서 **Strict Mode**가 기본 활성화됩니다.
Strict Mode는 컴포넌트의 순수성을 검증하기 위해 **state updater 함수를 의도적으로 2번 호출**합니다.

```
[사용자: 일기 작성]
      ↓
[setEntries 콜백 1번째 호출] → triggerAI() 실행 → 글 1개 생성
      ↓
[setEntries 콜백 2번째 호출] → triggerAI() 실행 → 글 1개 생성 (중복!)
```

### 해결 방법

```typescript
const addEntry = (content: string, mood: JournalEntry['mood']) => {
  setEntries(prev => [newEntry, ...prev]);  // 순수 함수 유지
  
  // ✅ triggerAI는 setState 콜백 "밖에서" 호출
  triggerAI({
    trigger: 'journal_added',
    data: { mood: ... },
  });
};
```

### 핵심 원칙
> **setState 콜백은 순수 함수여야 한다.**
> - 입력이 같으면 출력도 같아야 함
> - 외부 상태를 변경하면 안 됨 (API 호출, 다른 setState 등)
> - 사이드 이펙트는 **콜백 밖**에서 실행

### 수정된 핸들러
| 핸들러 | 수정 내용 |
|-------|----------|
| `addEvent` | 이미 올바름 |
| `addTodo` | ✅ triggerAI를 콜백 밖으로 이동 |
| `toggleTodo` | ✅ triggerAI를 콜백 밖으로 이동 |
| `addEntry` | ✅ triggerAI를 콜백 밖으로 이동 |

### 교훈
1. **React Strict Mode를 무시하지 말 것**: "왜 2번 실행되지?" → Strict Mode 의심
2. **setState 콜백은 순수해야 함**: 현재 상태를 받아 새 상태만 반환
3. **사이드 이펙트 분리**: 상태 업데이트와 외부 효과를 명확히 분리

---

## 관련 문서
- [[LifeSync AI]] - 프로젝트 개요
- [[개발일지]] - 개발 기록
- [[아키텍처]] - 시스템 구조

---

## 🐛 한글 깨짐(인코딩/모지바케) 문제

### 날짜
2026-02-08

### 증상
- 웹 UI에서 일부 한글이 깨져 보임
- 특히 카테고리/메뉴/라벨 텍스트가 비정상 문자열로 표시됨

### 원인 분석
1. 소스 파일은 UTF-8인데, 작업 환경/편집기에서 인코딩을 자동 추정하거나 다른 코드페이지(CP949 등)로 열어 저장하면 문자열이 모지바케로 오염될 수 있음
2. 과거 오염 데이터가 `localStorage`/DB에 남아 있으면, 코드가 정상이어도 화면에 계속 깨진 문자열이 재출력됨

### 해결 방법
1. 인코딩 고정
- `.editorconfig`: `charset = utf-8`, `end_of_line = lf`
- `.gitattributes`: 텍스트 파일 LF 강제
- `.vscode/settings.json`: `files.encoding = utf8`, `files.autoGuessEncoding = false`

2. 빌드 전 자동 검증
- `scripts/check-encoding.cjs` 추가
- `npm run check:encoding`로 UTF-8 유효성/BOM/주요 모지바케 패턴 검사
- `build` 스크립트에서 인코딩 검사 선실행

3. 런타임 방어
- `utils/encodingFix.ts` 추가
- `App.tsx` 로드 시점에 주요 사용자 표시 문자열 정규화(`normalizeKoreanText`) 적용

### 재발 방지 규칙
1. 텍스트 파일은 UTF-8 이외 인코딩으로 저장하지 않는다
2. 인코딩 자동 추정 기능을 끄고, 고정 인코딩으로만 작업한다
3. 배포 전 `npm run check:encoding`을 통과하지 못하면 배포하지 않는다
